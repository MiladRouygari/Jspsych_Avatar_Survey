<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8" />
    <title> Assessing National Affiliation from Appearances</title>

    <!-- jsPsych core + CSS -->
    <script src="https://unpkg.com/jspsych@8.2.2"></script>
    <link href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css" rel="stylesheet" />

    <!-- Plugins -->
    <script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe@0.4"></script>

  </head>
  <body></body>

  <script>

    // experiment ID from pipe.jspsych.org
    const expID = "AACa3FPLxrOU";
    const jsPsych = initJsPsych({});

    // Randomly generated Participant id
    const participant_id = jsPsych.randomization.randomID(10);
    jsPsych.data.addProperties({participant_id: participant_id});
    const filename = `${participant_id}.csv`;

    // ---- Welcome Page ----
    var welcome = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div style="max-width: 800px; margin: 100px auto; text-align: center;">
          <h1>Welcome to the Study</h1>

          <p>Thank you for participating in our research.</p>

          <p>In this experiment, you will see a series of photographs of different individuals (avatars).
          For each image, your task is to decide whether you think the person could hold a German passport or not.
          Please indicate your response using the keyboard: press <strong>F</strong> for “Yes” and <strong>J</strong> for “No.”
          (The question and response keys will remain the same throughout the entire experiment.) </p>

          <p> After you make your response, the next image will appear automatically.
          Before starting the main task, you will be asked to answer three brief personal questions.
          Once these are completed, the main part of the study will begin.
          </p>

          <p> We acknowledge that a person’s cultural or national background cannot be determined from appearance alone.
          However, for the purposes of this study, please base your judgments solely on your immediate visual impressions.
          </p>

          <p> To ensure reliable results, please follow these instructions:
          <ul>
          <li>Respond as quickly and instinctively as possible.</li>
          <li>There are no right or wrong answers.</li>
          <li>Base your judgments on your first impression.</li>
          </ul>
          </p>

          <p> The entire study will take approximately 8 minutes to complete.
          All responses will remain anonymous and will be used exclusively for research purposes. </p>
          <p> When you are ready, please press the <strong>spacebar</strong> to begin. </p>
        </div>
    `,

  choices: [' '],
};

// ---- Welcome Page ----
var screen_before_main = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style="max-width: 800px; margin: 100px auto; text-align: center;">
      <h1></h1>

      <p>main trial begins</p>

      <p>repeat some stuff from the welcome </p>
    </div>
`,

choices: [' '],
};

// ---- Personal info Page ----
var personal_info = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style="max-width: 800px; margin: 100px auto; text-align: center;">
      <h1></h1>

      <p>please answer the following personal questions</p>


    </div>
`,

choices: [' '],
};


    //  1 Personal information - Age
    var age = {
      type: jsPsychSurveyHtmlForm,
      preamble: '<p>Please enter your age below:</p>',
      html: `
        <p>
          <input
            name="age"
            type="text"
            pattern="^[0-9]+$"
            required
            inputmode="numeric"
            placeholder="Enter your age"
            oninput="this.value = this.value.replace(/[^0-9]/g, '');"
            />
        </p>
        `,
    };

    // 2 Personal information - Handness
    var handness = {
      type: jsPsychSurveyHtmlForm,
      preamble: '<p>Which hand do you use most often?</p>',
      html: `
        <p>
          <label><input type="radio" name="handedness" value="Right" required> Right</label><br>
          <label><input type="radio" name="handedness" value="Left"> Left</label><br>
          <label><input type="radio" name="handedness" value="Ambidextrous"> Ambidextrous</label>
        </p>
        `,
    };

    // 3 Personal information - Nationality
    var country = {
      type: jsPsychSurveyHtmlForm,
      preamble: '<p>What is your nationality?</p>',
      html: `
        <p>
          <input
            name="country"
            type="text"
            required
            placeholder="Enter your country"
          />
        </p>
        `,
    };

    // 4 Personal information - Gender
    var gender = {
      type: jsPsychSurveyHtmlForm,
      preamble: '<p>Which of the following best describes your gender?</p>',
      html: `
        <p>
          <label><input type="radio" name="handedness" value="Female" required> Female</label><br>
          <label><input type="radio" name="handedness" value="Male"> Male</label><br>
          <label><input type="radio" name="handedness" value="Diverse"> Diverse</label>
        </p>
        `,
    };


    // Example Trial
    const example_trial = {
      type: jsPsychImageKeyboardResponse,
      stimulus: 'img/example.png',
      choices: ['F', 'J'], // Or your specific choices
      prompt: `
        <div style="font-size:16px; line-height:1.4;">
          <p>Does this person look like someone who could hold a German passport?</p>
          <div style="display:flex; justify-content:space-between; margin-top:8px;">
            <div style="text-align:left;">
              <span><strong>F = Yes</strong></span>
            </div>
            <div style="text-align:right;">
              <span><strong>J = No</strong> </span>
            </div>
          </div>
        </div>
  `,
      stimulus_height: 400,
      maintain_aspect_ratio: true,
      data: {task: 'image_trial'},
      post_trial_gap: 400 // 400 ms pause before the next image
    };

    //const image_files = ['img/1.png', 'img/2.png', 'img/3.png'];
    const imageCount = 98; // change this to however many images you have
    const image_files = Array.from({ length: imageCount }, (_, i) => `img/${i + 1}.png`);

    const shuffled_images = jsPsych.randomization.shuffle(image_files);



    // Main Trial
    const trial = {
      type: jsPsychImageKeyboardResponse,
      stimulus: jsPsych.timelineVariable('image'), // pulls the image path from the timeline variable
      choices: ['F', 'J'], // Or your specific choices
      prompt: `
        <div style="font-size:16px; line-height:1.4;">
          <p>Does this person look like someone who could hold a German passport?</p>
          <div style="display:flex; justify-content:space-between; margin-top:8px;">
            <div style="text-align:left;">
              <span><strong>F = Yes</strong></span>
            </div>
            <div style="text-align:right;">
              <span><strong>J = No</strong> </span>
            </div>
          </div>
        </div>
  `,
      stimulus_height: 400,
      maintain_aspect_ratio: true,
      data: {task: 'image_trial'},
      post_trial_gap: 400 // 400 ms pause before the next image
    };

    const timeline_variables = [];
    for (let i = 0; i < shuffled_images.length; i++) {
      timeline_variables.push({ image: shuffled_images[i] });
    }

    // Example with a block of trials
    const random_image_block = {
      timeline: [trial],
      timeline_variables: timeline_variables,
      randomize_order: false // Set to false if you want the shuffle to be outside the timeline
    };



    // ---- End Screen ----
    const end = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div style="max-width: 800px; margin: 100px auto; text-align: center;">
          <h1>Thank you!</h1>
          <p>You’ve reached the end of the experiment.</p>
          <p><em>Press any key to record your responses, and please wait while we save your results.</em></p>
        </div>
      `,
      choices: "ALL_KEYS",
    };


    var preload = {
      type: jsPsychPreload,
      images: shuffled_images
    };

    // OSF + Pipeline
    const save_data = {
      type: jsPsychPipe,
      action: "save",
      experiment_id: expID,
      filename: filename,
      data_string: ()=>jsPsych.data.get().csv()
    };

    // ---- Build timeline ----
    var timeline = [preload, welcome, example_trial, screen_before_main,
      random_image_block, personal_info, age, gender, handness, country, end, save_data];


    // ---- Run experiment ---
    jsPsych.run(timeline).then(() => {
      // uncomment if you want a local download too
      //jsPsych.data.get().localSave('csv','data.csv');

});
  </script>

</html>
