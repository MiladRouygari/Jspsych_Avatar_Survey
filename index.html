<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8" />
    <title> Assessing National Affiliation from Appearances</title>

    <!-- jsPsych core + CSS -->
    <script src="https://unpkg.com/jspsych@8.2.2"></script>
    <link href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css" rel="stylesheet" />

    <!-- Plugins -->
    <script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe@0.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3"></script>


    <style>
      .recap-wrap{
        max-width: 720px;
        margin: 0 auto;
        text-align: left;
        line-height: 1.45;
      }
      .recap-wrap h2{
        text-align:center;
        margin: 0 0 12px 0;
        font-size: 28px;
      }
      .recap-list{
        list-style: none;
        padding: 0;
        margin: 0 0 14px 0;
      }
      .recap-list li{
        display: grid;
        grid-template-columns: 20px 1fr;
        align-items: start;
        column-gap: 10px;
        margin: 8px 0;
      }
      .recap-list li::before{
        content: "";
        width: 8px;
        height: 8px;
        margin-top: 8px;
        border-radius: 999px;
        background: currentColor;
        opacity: 0.7;
        display: inline-block;
      }
      .recap-wrap p{
        margin: 0;
        text-align: center;
      }
      /* Pretty keyboard keys */
      kbd{
        border: 1px solid #cfcfcf;
        border-bottom-width: 2px;
        padding: 2px 8px;
        border-radius: 6px;
        font-weight: 700;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        background: #f7f7f7;
        box-shadow: inset 0 -1px 0 rgba(0,0,0,0.05);
      }

        /* bullets close to text */
        .bullets-tight{
          list-style-position: inside; /* bullet sits inside the text box */
          padding-left: 0;             /* remove default indent */
          margin-left: 0;
          margin-right: 0;
        }

        /* optional: center the whole list but keep lines left-aligned */
        .bullets-tight{
          width: max-content;
          margin: 0 auto;      /* centers the UL */
          text-align: left;    /* keeps text left-aligned */
        }


    </style>

  </head>
  <body></body>

  <script>

    // experiment ID from pipe.jspsych.org
    const expID = "AACa3FPLxrOU";
    const jsPsych = initJsPsych({});

    // Randomly generated Participant id
    const participant_id = jsPsych.randomization.randomID(10);

    // 50/50 using Math.random()
    const condition = Math.random() < 0.5 ? 1 : 2;
    // mapping from your condition
    const isYesLeft = condition === 1;
    //const KEY_YES = isYesLeft ? 'arrowleft' : 'arrowright';
    //const KEY_NO  = isYesLeft ? 'arrowright' : 'arrowleft';

    jsPsych.data.addProperties({participant_id: participant_id, condition: condition});

    const filename = `${participant_id}.csv`;

    // ---- Welcome Page ----
    // To be used in the welcome page
    const arrowRow = `
      <div>
        <kbd title="Left Arrow" aria-label="Left Arrow">&larr;</kbd> ${isYesLeft ? 'Yes' : 'No'}, &nbsp;&nbsp;
        <kbd title="Right Arrow" aria-label="Right Arrow">&rarr;</kbd> ${isYesLeft ? 'No' : 'Yes'}
      </div>
    `;
    var welcome = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div style="max-width: 800px; margin: 100px auto; text-align: center;">
          <h1>Welcome to the Study</h1>

          <p>Thank you for participating in our research.</p>

          <p>In this experiment, you will see a series of photographs of different individuals (avatars).<br>
          For each image, your task is to decide whether you think the person could <br><b><i>hold a German passport or not</b></i>.
          Please indicate your response using the keyboard:
            ${arrowRow} </p>

            <p> Use a symmetrical, two-handed response: <br> press the <b>left arrow</b> with your <b>left</b> hand and the <b>right arrow</b> with your <b>right</b> hand.</p>
          <p><b>The question and response keys</b> will remain the <b>same</b> throughout the entire experiment. </p>

          <p>After you submit your response, the <b>next image</b> will appear <b> automatically</b>.
          Before the main task, you will see an <b>example image</b>;
          the main trials will then begin.
          Once you <b>finish the main trials</b>, you will answer a few brief <b>personal questions</b>.</p>

          <p> We acknowledge that a person’s cultural or national background cannot be determined from appearance alone.
          However, for the purposes of this study, please base your judgments solely on your immediate visual impressions.
          </p>

          <p> To ensure reliable results, please follow these instructions:
          <ul class="bullets-tight">
          <li>Respond as quickly and instinctively as possible.</li>
          <li>There are no right or wrong answers.</li>
          <li>Base your judgments on your first impression.</li>
          </ul>
          </p>

          <p> The entire study will take approximately <b>5 minutes</b> to complete.
          All responses will remain anonymous and will be used exclusively for research purposes. </p>
          <p> When you are ready, please press the <strong>spacebar</strong> to see the example trial. </p>
        </div>
    `,

  choices: [' '],
};


// ---- Screen for the main trial Page ----
var screen_before_main = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
  <div class="recap-wrap">
    <h2>Quick recap about the study</h2>
    <br>

    <ul class="recap-list">
      <li>
        <div>The question and response keys stays the same throughout:<br>
          <em> &nbsp;&nbsp; “Could this person hold a German passport?”</em>
           ${arrowRow}
        </div>
      </li>

      <li>
        <div>Respond quickly, based on your first impression.</div>
      </li>
      <li>
        <div>The next image appears automatically after your response.</div>
      </li>
    </ul>
    <br>
    <p> The main trials are about to begin. When you’re ready, press the <strong>spacebar</strong> to start.</p>
  </div>
  `,


choices: [' '],
};



// ---- Personal info Page ----
var personal_info = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style="max-width: 800px; margin: 100px auto; text-align: center;">
    <h1>Personal Information</h1>

    <p>The main experiment is now complete. Before we finish, we still need to collect some personal information.
    In the next section, you will be asked four brief personal/demographic questions needed for this study.</p>

    <p>All items are required.</p>

    <p>When you are ready, please press the <strong>spacebar</strong> to proceed.</p>

    </div>
`,

choices: [' '],
};


    //  1 Personal information - Age
    var age = {
      type: jsPsychSurveyHtmlForm,
      preamble: '<p>Please enter your age below:</p>',
      html: `
        <p>
          <input
            name="age"
            type="text"
            pattern="^[0-9]+$"
            required
            inputmode="numeric"
            placeholder="Enter your age"
            oninput="this.value = this.value.replace(/[^0-9]/g, '');"
            />
        </p>
        `,
    };

    // 2 Personal information - Handness
    var handness = {
      type: jsPsychSurveyHtmlForm,
      preamble: '<p>Which hand do you use most often?</p>',
      html: `
        <p>
          <label><input type="radio" name="handedness" value="Right" required> Right</label><br>
          <label><input type="radio" name="handedness" value="Left"> Left</label><br>
          <label><input type="radio" name="handedness" value="Ambidextrous"> Ambidextrous</label>
        </p>
        `,
    };

    // 3 Personal information - Nationality
    var country = {
      type: jsPsychSurveyHtmlForm,
      preamble: '<p>What is your nationality?</p>',
      html: `
        <p>
          <input
            name="country"
            type="text"
            required
            placeholder="Enter your country"
          />
        </p>
        `,
    };

    // 4 Personal information - Gender
    var gender = {
      type: jsPsychSurveyHtmlForm,
      preamble: '<p>Which of the following best describes your gender?</p>',
      html: `
        <p>
          <label><input type="radio" name="gender" value="Female" required> Female</label><br>
          <label><input type="radio" name="gender" value="Male"> Male</label><br>
          <label><input type="radio" name="gender" value="Diverse"> Diverse</label>
        </p>
        `,
    };

    // 5 Personal information - Comment
    const commentTrial = {
      type: jsPsychSurveyText,
      questions: [
        {
          prompt: '<h3>Open feedback (optional)</h3> <p>Please share any suggestions, uncertainties, or additional comments. Or Continue with no comment.</p>',
          name: 'comments',
          placeholder: 'Type here…',
          rows: 10,        // height
          columns: 100,    // width (approximate, in characters)
          required: false
        }
      ],
    };

    // Example Trial
    const example_trial_1 = {
      type: jsPsychImageKeyboardResponse,
      stimulus: 'img/example.png',
      choices: ['arrowleft', 'arrowright'],
      prompt: `
        <div style="font-size:16px; line-height:1.4;">
          <p>Does this person look like someone who could hold a German passport?</p>
          <div style="display:flex; justify-content:space-between; margin-top:8px;">
            <div style="text-align:left; font-size:1.4em;">
              <kbd title="Left Arrow" aria-label="Left Arrow">&larr;</kbd> Yes
            </div>
            <div style="text-align:right; font-size:1.4em;">
              <kbd title="Right Arrow" aria-label="Right Arrow">&rarr;</kbd> No
            </div>
          </div>
        </div>
  `,
      stimulus_height: 400,
      maintain_aspect_ratio: true,
      data: {task: 'image_trial'},
      post_trial_gap: 200 // 400 ms pause before the next image
    };

    const example_trial_2 = {
      type: jsPsychImageKeyboardResponse,
      stimulus: 'img/example.png',
      choices: ['arrowright', 'arrowleft'],
      prompt: `
        <div style="font-size:16px; line-height:1.4;">
          <p>Does this person look like someone who could hold a German passport?</p>
          <div style="display:flex; justify-content:space-between; margin-top:8px;">
            <div style="text-align:left; font-size:1.4em;">
              <kbd title="Left Arrow" aria-label="Left Arrow">&larr;</kbd> No
            </div>
            <div style="text-align:right; font-size:1.4em;">
              <kbd title="Right Arrow" aria-label="Right Arrow">&rarr;</kbd> Yes
            </div>
          </div>
        </div>
  `,
      stimulus_height: 400,
      maintain_aspect_ratio: true,
      data: {task: 'image_trial'},
      post_trial_gap: 200 // 400 ms pause before the next image
    };

    //const image_files = ['img/1.png', 'img/2.png', 'img/3.png'];
    const imageCount = 5; // change this to however many images you have
    const image_files = Array.from({ length: imageCount }, (_, i) => `img/${i + 1}.png`);

    const shuffled_images = jsPsych.randomization.shuffle(image_files);

    // Main Trial
    const trial_1 = {
      type: jsPsychImageKeyboardResponse,
      stimulus: jsPsych.timelineVariable('image'), // pulls the image path from the timeline variable
      choices: ['arrowleft', 'arrowright'],
      prompt: `
        <div style="font-size:16px; line-height:1.4;">
          <p>Does this person look like someone who could hold a German passport?</p>
          <div style="display:flex; justify-content:space-between; margin-top:8px;">
            <div style="text-align:left; font-size:1.4em;">
              <kbd title="Left Arrow" aria-label="Left Arrow">&larr;</kbd> Yes
            </div>
            <div style="text-align:right; font-size:1.4em;">
              <kbd title="Right Arrow" aria-label="Right Arrow">&rarr;</kbd> No
            </div>
          </div>
        </div>
  `,
      stimulus_height: 400,
      maintain_aspect_ratio: true,
      data: {task: 'image_trial'},
      post_trial_gap: 400 // 400 ms pause before the next image
    };

    const timeline_variables = [];
    for (let i = 0; i < shuffled_images.length; i++) {
      timeline_variables.push({ image: shuffled_images[i] });
    }

    // Example with a block of trials
    const random_image_block_1 = {
      timeline: [trial_1],
      timeline_variables: timeline_variables,
      randomize_order: false // Set to false if you want the shuffle to be outside the timeline
    };

    const trial_2 = {
      type: jsPsychImageKeyboardResponse,
      stimulus: jsPsych.timelineVariable('image'), // pulls the image path from the timeline variable
      choices: ['arrowleft', 'arrowright'],
      prompt: `
        <div style="font-size:16px; line-height:1.4;">
          <p>Does this person look like someone who could hold a German passport?</p>
          <div style="display:flex; justify-content:space-between; margin-top:8px;">
            <div style="text-align:left; font-size:1.4em;">
              <kbd title="Left Arrow" aria-label="Left Arrow">&larr;</kbd> No
            </div>
            <div style="text-align:right; font-size:1.4em;">
              <kbd title="Right Arrow" aria-label="Right Arrow">&rarr;</kbd> Yes
            </div>
          </div>
        </div>
  `,
      stimulus_height: 400,
      maintain_aspect_ratio: true,
      data: {task: 'image_trial'},
      post_trial_gap: 400 // 400 ms pause before the next image
    };
    // Example with a block of trials
    const random_image_block_2 = {
      timeline: [trial_2],
      timeline_variables: timeline_variables,
      randomize_order: false // Set to false if you want the shuffle to be outside the timeline
    };


    // ---- End Screen ----
    const end = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div style="max-width: 800px; margin: 100px auto; text-align: center;">
          <h1>Thank you!</h1>
          <p>You’ve reached the end of the experiment.</p>
          <p><em>Press any key to record your responses, and please wait while we save your results.</em></p>
          <p>An indicator will appear. When the indicator disappears, your data have been saved and you are free to close this tab.</p>

        </div>
      `,
      choices: "ALL_KEYS",
    };


    var preload = {
      type: jsPsychPreload,
      images: shuffled_images
    };

    // OSF + Pipeline
    const save_data = {
      type: jsPsychPipe,
      action: "save",
      experiment_id: expID,
      filename: filename,
      data_string: ()=>jsPsych.data.get().csv()
    };

    const variants = {
      1: {
        example: example_trial_1,
        random:  random_image_block_1
      },
      2: {
        example: example_trial_2,
        random:  random_image_block_2
      }
    };

    // --- Build timeline using the chosen variants ---
    const v = variants[condition];

    const timeline = [
      preload,
      welcome,
      v.example,
      screen_before_main,
      v.random,
      personal_info,
      age,
      gender,
      handness,
      country,
      commentTrial,
      end,
      save_data
    ];





    // ---- Build timeline ----
    // var timeline = [preload, welcome, example_trial, screen_before_main,
    //   random_image_block, personal_info, age, gender, handness, country, commentTrial, end, save_data];


    // ---- Run experiment ---
    jsPsych.run(timeline).then(() => {
      // uncomment if you want a local download too
      jsPsych.data.get().localSave('csv','data.csv');

});
  </script>

</html>
